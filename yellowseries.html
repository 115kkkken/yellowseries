<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>亞維聯盟</title>
  <style>
    :root{
      --topbar-height:64px;
      --accent:#7dd3fc;
      --bg:#0b0b0b;
      --panel: rgba(255,255,255,0.03);
    }
    html,body{height:100%;margin:0;background:var(--bg);color:#eee;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans",Arial;}
  
    .topbar{
      position:fixed; left:0; right:0; top:0; height:var(--topbar-height);
      display:flex; align-items:center; justify-content:center; gap:22px;
      background:linear-gradient(180deg, rgba(0,0,0,0.9), rgba(0,0,0,0.75));
      border-bottom:1px solid rgba(255,255,255,0.04); z-index:999;
      padding:8px 14px; box-sizing:border-box;
    }
    .topbar .label{font-size:13px; color:#cdd; opacity:.9; margin-right:6px;}
    .topbar .value{font-weight:700; color:var(--accent); min-width:36px; text-align:right;}
    .container{max-width:1100px;margin: calc(var(--topbar-height) + 16px) auto 60px; padding:0 16px; box-sizing:border-box;}
    h1{font-size:18px;text-align:center;margin:6px 0;}
    .subtitle{opacity:.85;text-align:center;margin-bottom:10px;font-size:13px;}
    .stage-tabs{display:flex;gap:8px;justify-content:center;margin-bottom:10px;}
    .stage-tabs button{padding:8px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#ddd;cursor:pointer;}
    .stage-tabs button.active{background:var(--panel); box-shadow:0 4px 12px rgba(0,0,0,0.6); color:var(--accent);}
    .grid{display:flex;gap:16px;}
    .col{flex:1; min-width:280px;}
    .panel{background:var(--panel); border-radius:10px; padding:12px; border:1px solid rgba(255,255,255,0.04);}
    .leaders{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;}
    .leader{width:22%;min-width:140px; text-align:center; cursor:pointer; user-select:none;}
    .leader img{width:100%;border-radius:8px;display:block;border:2px solid transparent;}
    .leader .label{margin-top:6px;font-weight:600;color:#ddd;}
    .leader.selected img{border-color:var(--accent); box-shadow:0 0 12px rgba(125,211,252,0.08);}
    .section-title{font-weight:700;margin-bottom:8px;color:#cfe8ff;}
    .card-list{display:flex;flex-wrap:wrap;gap:10px;}
    .card-item{width:calc(33.333% - 8px); min-width:140px; background:rgba(255,255,255,0.02); padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,0.03); box-sizing:border-box;}
    .card-item img{width:100%; border-radius:6px; display:block; height:140px; object-fit:cover; cursor:zoom-in;}
    .card-meta{display:flex;justify-content:space-between;align-items:center;margin-top:6px;font-size:13px;}
    .card-meta .small{opacity:.9;}
    .card-controls{display:flex;align-items:center;gap:8px;margin-top:8px;justify-content:center;}
    .card-controls button{padding:6px 8px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--accent);cursor:pointer;}
    .card-controls input[type="checkbox"]{transform:scale(1.1);}
    .sub-gallery{display:flex;flex-wrap:wrap;gap:12px;margin-top:12px;justify-content:center;}
    .sub-card{width:calc(20% - 12px);min-width:140px;background:rgba(255,255,255,0.02);border-radius:8px;padding:8px;box-sizing:border-box;border:1px solid rgba(255,255,255,0.03);}
    .sub-card img{width:100%;border-radius:6px; display:block; height:120px; object-fit:cover; cursor:zoom-in;}
    .card-cost{color:#9ae6b4;font-weight:700;margin-top:6px;}
    .card-max{margin-top:4px;color:#cfe8ff;opacity:.9;font-size:13px;}
    .count{min-width:36px;text-align:center;font-weight:700;}
    .count-controls{display:flex;align-items:center;justify-content:center;gap:8px;margin-top:8px;}
    .count-controls button{width:34px;height:34px;border-radius:6px;border:1px solid rgba(125,211,252,0.08);background:rgba(125,211,252,0.04);color:var(--accent);font-size:18px;cursor:pointer;}
    .count-controls button:disabled{opacity:.45;cursor:not-allowed;}
    .selected-units-wrap{margin-top:18px;}
    .selected-units{display:flex;flex-wrap:wrap;gap:12px;justify-content:center;margin-top:8px;}
    .unit-card{width:calc(20% - 12px);min-width:160px;background:rgba(255,255,255,0.02);border-radius:8px;padding:8px;box-sizing:border-box;border:1px solid rgba(255,255,255,0.03);}
    .unit-card img{width:100%;border-radius:6px; display:block; height:120px; object-fit:cover; cursor:zoom-in;}
    .unit-card .unit-title{font-weight:700;margin-top:6px;}
    .upgrades{display:flex;flex-direction:column;gap:6px;margin-top:8px;}
    .upgrade-btn{padding:6px 8px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--accent);cursor:pointer;}
    .upgrade-btn.active{background:rgba(125,211,252,0.12);box-shadow:0 0 8px rgba(125,211,252,0.06);}
    .unit-actions{display:flex;gap:8px;margin-top:8px;justify-content:center;}
    .btn-small{padding:6px 8px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--accent);cursor:pointer;}
    .footer-actions{display:flex;justify-content:center;margin-top:12px;gap:8px;}
    .btn-primary{background:var(--accent); color:#012; border:none;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:700;}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#ddd;padding:8px 12px;border-radius:8px;cursor:pointer;}
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:10000;}
    .modal{background:#071018;padding:16px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);width:90%;max-width:560px;}
    .modal h3{margin:0 0 8px 0;}
    .modal label{display:block;margin-top:8px;font-size:13px;color:#cfe8ff;}
    .modal input[type="text"], .modal textarea{width:100%;box-sizing:border-box;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:#fff;}
    .hint{font-size:13px;color:#cdd;margin-top:6px;text-align:center;}
    @media (max-width:900px){ .card-item{width:calc(50% - 8px);} .sub-card{width:calc(33.333% - 12px);} .leader{width:45%;} .unit-card{width:calc(33.333% - 12px);} }
    @media (max-width:520px){ .card-item{width:100%;} .sub-card{width:calc(50% - 12px);} .leader{width:100%;} .unit-card{width:calc(50% - 12px);} }
    .flash{animation:flash 360ms ease;} @keyframes flash{0%{box-shadow:none;}40%{box-shadow:0 0 10px rgba(255,0,0,0.6);}100%{box-shadow:none;}}

    /* ---------- Image zoom (lightbox) styles (use left/top/width/height animation for sharpness) ---------- */
    .img-zoom-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.75);
      z-index:12000;
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events:auto;
      opacity:0;
      transition:opacity .28s ease;
    }
    .img-zoom-backdrop.show{opacity:1;}
    .img-zoom-clone{
      position:fixed;
      z-index:12001;
      border-radius:10px;
      box-shadow:0 30px 80px rgba(0,0,0,0.7);
      transition:left .34s cubic-bezier(.2,.9,.25,1), top .34s cubic-bezier(.2,.9,.25,1), width .34s cubic-bezier(.2,.9,.25,1), height .34s cubic-bezier(.2,.9,.25,1);
      cursor:zoom-out;
      background:transparent;
      overflow:hidden;
      will-change:left,top,width,height;
    }
    .img-zoom-clone img{ width:100%; height:100%; object-fit:contain; display:block; pointer-events:none; user-select:none; }
    body.img-zoom-open { touch-action: none; user-select: none; -webkit-user-select:none; }
  </style>
</head>
<body>

  <!-- Topbar: remaining budget + selected card total count -->
  <div class="topbar" aria-hidden="false">
    <div style="display:flex;align-items:center;gap:8px">
      <div class="label">剩餘費用</div>
      <div id="remainingBudget" class="value">20</div>
    </div>
    <div style="width:18px"></div>
    <div style="display:flex;align-items:center;gap:8px">
      <div class="label">已選卡牌數量</div>
      <div id="selectedCount" class="value">0</div>
    </div>
    <div style="width:18px"></div>
    <div id="loadingStatus" style="color:#cfe8ff;font-size:13px;opacity:.9"></div>
  </div>

  <div class="container">
    <h1>亞維聯盟</h1>

    <div class="stage-tabs" role="tablist" aria-label="階段切換">
      <button id="tabCamp" class="active">大本營牌庫</button>
      <button id="tabLineup">軍表</button>
    </div>

    <!-- CAMP -->
    <div id="campStage">
      <div class="panel">
        <div class="section-title">選擇領主</div>
        <div class="leaders" id="leadersList"></div>
        
      </div>

      <div style="height:12px;"></div>

      <div class="grid">
        <div class="col panel">
          <div class="section-title">同種族單位（同領主類型自動加入 / 其他種族最多可選 2 張）</div>
          <div id="aCardsArea" class="card-list"></div>
          <div class="hint" id="aLimitHint"></div>
        </div>

        <div class="col panel">
          <div class="section-title">英雄單位</div>
          <div id="bCardsArea" class="card-list"></div>
        </div>

        <div class="col panel">
          <div class="section-title">中立卡（最多 2 種）</div>
          <div id="cCardsArea" class="card-list"></div>
          <div class="hint" id="cLimitHint"></div>
        </div>
      </div>
      <div class="page">
      <div class="footer-actions">
        <button class="btn-primary" id="enterLineupBtn">建立大本營</button>
        
        <button class="btn-ghost" id="resetCampBtn">重置大本營</button>
      </div>
    </div>
    </div>
    <!-- LINEUP -->
    <div id="lineupStage" style="display:none;">
      <div class="panel">
        <div class="section-title">構件軍表 (起始場上單位)</div>
        
        <div id="lineupGallery" class="sub-gallery"></div>

        <!-- Selected units area (shows chosen units bottom of page) -->
        <div class="selected-units-wrap">
          <div class="section-title" style="margin-top:12px;">已選擇的單位(場上起始單位)</div>
          <div id="selectedUnits" class="selected-units"></div>
        </div>

      </div>

      <div class="footer-actions" style="margin-top:14px;">
        <button class="btn-primary" id="confirmBtn">確認軍表</button>
        <button class="btn-ghost" id="backToCampBtn">返回編輯大本營</button>
        <button class="btn-ghost" id="clearLineupBtn">重置軍表構築</button>
      </div>
    </div>

  </div>

<script>
  // ---------------------------
  // Image preloading / caching
  // ---------------------------
  const imageCache = {}; // map: cardId -> Image object
  let preloadDone = false;

  async function preloadImagesForAll() {
    const items = [];
    const pushUnique = (id, img) => {
      if (!id || !img) return;
      if (!items.some(it => it.id === id)) items.push({ id, img });
    };

    leaders.forEach(l => pushUnique(l.id, l.img));
    Object.values(aCardsByType).flat().forEach(c => pushUnique(c.id, c.img));
    bCards.forEach(c => pushUnique(c.id, c.img));
    cCards.forEach(c => pushUnique(c.id, c.img));

    const statusEl = document.getElementById('loadingStatus');
    statusEl.textContent = '正在預載圖片…';
    await Promise.all(items.map(item => new Promise(resolve => {
      const img = new Image();
      img.onload = () => { imageCache[item.id] = img; resolve(); };
      img.onerror = () => { imageCache[item.id] = null; resolve(); };
      img.src = item.img;
    })));
    statusEl.textContent = '';
    preloadDone = true;
  }

  // ---------------------------
  // Helpers and data
  // ---------------------------
  const MAX_BUDGET = 20;
  let usedBudget = 0;

  const UPGRADES = [
    { key: 'atk', label: '攻擊 +2', cost: 1 },
    { key: 'move', label: '移動 +2', cost: 1 },
    { key: 'life', label: '生命 +2', cost: 1 },
    { key: 'morale', label: '士氣 +3', cost: 1 },
    { key: 'tenacity', label: '堅韌 +1', cost: 1 }
  ];

  function imgForId(id){
    return `${id.toLowerCase()}.webp`; // adjust to your filenames
  }

  const leaders = [
    { id:'L_D_A', name:'大祭司長 亞瑟', type:'demon', img: imgForId('L_D_A') },
    { id:'L_D_B', name:'眾神之星 亞瑟', type:'demon', img: imgForId('L_D_B') },
    { id:'L_T_A', name:'聖光教皇 烏爾班二世', type:'tomb',  img: imgForId('L_T_A') },
    { id:'L_T_B', name:'聖潔者 烏爾班二世', type:'tomb',  img: imgForId('L_T_B') },
    { id:'L_N_A', name:'幽冥 領主 A', type:'nether', img: imgForId('L_N_A') },
    { id:'L_N_B', name:'幽冥 領主 B', type:'nether', img: imgForId('L_N_B') }
  ];

  const aCardsByType = {
    demon: [
      { id:'A_DE_1', name:'大天使', cost:7, maxCopies:2, img: imgForId('A_DE_1') },
      { id:'A_DE_2', name:'冠軍勇士', cost:3, maxCopies:4, img: imgForId('A_DE_2') },
      { id:'A_DE_3', name:'獅鷲騎士', cost:5, maxCopies:4, img: imgForId('A_DE_3') },
      { id:'A_DE_4', name:'聖團老兵', cost:1, maxCopies:5, img: imgForId('A_DE_4') },
      { id:'A_DE_5', name:'破法者', cost:2, maxCopies:3, img: imgForId('A_DE_5') },
      { id:'A_DE_6', name:'神之猛禽', cost:0, maxCopies:0, img: imgForId('A_DE_6') }
    
    ],
    tomb: [
      { id:'A_TO_1', name:'聖殿騎士', cost:4, maxCopies:3, img: imgForId('A_TO_1') },
      { id:'A_TO_2', name:'教皇禁衛隊', cost:3, maxCopies:4, img: imgForId('A_TO_2') },
      { id:'A_TO_3', name:'焰陽法師', cost:5, maxCopies:3, img: imgForId('A_TO_3') },
      { id:'A_TO_4', name:'城堡弩手', cost:1, maxCopies:5, img: imgForId('A_TO_4') },
      { id:'A_TO_5', name:'持盾鐵衛', cost:2, maxCopies:5, img: imgForId('A_TO_5') },
      
      
    ],
    nether: [
      { id:'A_NT_1', name:'幽影獵手', cost:2, maxCopies:3, img: imgForId('A_NT_1') },
      { id:'A_NT_2', name:'冥火術士', cost:3, maxCopies:2, img: imgForId('A_NT_2') },
      { id:'A_NT_3', name:'虛無行者', cost:4, maxCopies:1, img: imgForId('A_NT_3') },
      { id:'A_NT_4', name:'沉默守衛', cost:2, maxCopies:3, img: imgForId('A_NT_4') },
      { id:'A_NT_5', name:'幽冥博士', cost:1, maxCopies:5, img: imgForId('A_NT_5') }
    ]
  };

  const bCards = [
    { id:'B_1', name:'雷神泰坦', cost:9, maxCopies:1, img: imgForId('B_1') },
    { id:'B_2', name:'金為師王 理查德', cost:7, maxCopies:1, img: imgForId('B_2') },
    { id:'B_3', name:'前線增援', cost:3, maxCopies:1, img: imgForId('B_3') }
  ];

  const cCards = [
    { id:'c_1', name:'鈦晶加工器', cost:3, maxCopies:3, img: imgForId('C_1') },
    { id:'c_2', name:'鐵刺傭兵團', cost:1, maxCopies:3, img: imgForId('C_2') },
    { id:'c_3', name:'矮人護衛', cost:2, maxCopies:3, img: imgForId('C_3') },
    { id:'c_4', name:'復仇之魂', cost:2, maxCopies:3, img: imgForId('C_4') },
    { id:'c_5', name:'外交使節', cost:3, maxCopies:2, img: imgForId('C_5') },
    { id:'c_6', name:'哨塔工程兵', cost:1, maxCopies:3, img: imgForId('C_6') },
    { id:'c_7', name:'貪欲魅妖', cost:1, maxCopies:3, img: imgForId('C_7') },
    { id:'c_8', name:'猛馬戰象', cost:5, maxCopies:3, img: imgForId('C_8') },
    { id:'c_9', name:'奴隸動員兵團', cost:0, maxCopies:2, img: imgForId('C_9') },
    { id:'c_10', name:'烏拉標騎團', cost:2, maxCopies:3, img: imgForId('C_10') },
    { id:'c_11', name:'血瘟鼠群', cost:2, maxCopies:3, img: imgForId('C_11') },
    { id:'c_12', name:'嗜血液叉', cost:4, maxCopies:3, img: imgForId('C_12') },
    { id:'c_13', name:'聰慧戰略家 漢尼拔', cost:0, maxCopies:1, img: imgForId('C_13') },
    { id:'c_14', name:'烈火龍王', cost:0, maxCopies:1, img: imgForId('C_14') },
  ];

  // STATE
  let chosenLeaderId = null;
  const campSelections = new Set();
  const selectedOtherA = new Set();
  const selectedCtypes = new Set();
  let campCards = [];
  const lineupCounts = new Map();
  const units = [];

  // UI refs
  const leadersList = document.getElementById('leadersList');
  const aCardsArea = document.getElementById('aCardsArea');
  const bCardsArea = document.getElementById('bCardsArea');
  const cCardsArea = document.getElementById('cCardsArea');
  const aLimitHint = document.getElementById('aLimitHint');
  const cLimitHint = document.getElementById('cLimitHint');

  const tabCamp = document.getElementById('tabCamp');
  const tabLineup = document.getElementById('tabLineup');
  const campStage = document.getElementById('campStage');
  const lineupStage = document.getElementById('lineupStage');

  const lineupGallery = document.getElementById('lineupGallery');
  const selectedUnitsEl = document.getElementById('selectedUnits');

  const remainingBudgetEl = document.getElementById('remainingBudget');
  const selectedCountEl = document.getElementById('selectedCount');

  remainingBudgetEl.textContent = MAX_BUDGET;
  selectedCountEl.textContent = 0;

  // ---------- Image zoom state ----------
  let currentZoom = null; // { backdropEl, cloneEl, originalRect, originalImgEl }
  let escKeyListener = null;

  // find imageCache entry by matching src
  function findCacheEntryBySrc(src){
    for(const id in imageCache){
      const img = imageCache[id];
      if(!img) continue;
      if(img.src === src) return { id, img };
    }
    return null;
  }

  function openImageZoomFromElement(imgEl){
    if(!imgEl) return;
    const src = imgEl.src || imgEl.getAttribute('src');
    if(!src) return;
    if(currentZoom) { closeImageZoom(); return; }

    const rect = imgEl.getBoundingClientRect();
    const vw = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
    const vh = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);

    // try to get full-size natural dimensions from imageCache if possible
    const cacheEntry = findCacheEntryBySrc(src);
    const naturalW = (cacheEntry && cacheEntry.img && cacheEntry.img.naturalWidth) ? cacheEntry.img.naturalWidth : (imgEl.naturalWidth || rect.width);
    const naturalH = (cacheEntry && cacheEntry.img && cacheEntry.img.naturalHeight) ? cacheEntry.img.naturalHeight : (imgEl.naturalHeight || rect.height);
    const highResSrc = (cacheEntry && cacheEntry.img && cacheEntry.img.src) ? cacheEntry.img.src : src;

    // create backdrop & clone
    const backdrop = document.createElement('div');
    backdrop.className = 'img-zoom-backdrop';
    backdrop.setAttribute('role','dialog');
    backdrop.setAttribute('aria-modal','true');
    backdrop.tabIndex = -1;

    const clone = document.createElement('div');
    clone.className = 'img-zoom-clone';
    // initial geometry: same as source rect (viewport coordinates)
    clone.style.left = rect.left + 'px';
    clone.style.top = rect.top + 'px';
    clone.style.width = rect.width + 'px';
    clone.style.height = rect.height + 'px';

    // inner high-res image
    const inner = document.createElement('img');
    inner.alt = imgEl.alt || '';
    inner.src = highResSrc;
    clone.appendChild(inner);

    document.body.appendChild(backdrop);
    document.body.appendChild(clone);
    document.body.classList.add('img-zoom-open');
    // prevent body scrolling while open
    document.body.style.overflow = 'hidden';

    // compute target size while preserving aspect ratio, but do NOT upscale beyond natural size
    const maxW = vw * 0.96; // leave small margin
    const maxH = vh * 0.94;
    // start with natural size bounded by maxW/maxH
    let targetW = Math.min(naturalW, maxW);
    let targetH = naturalH * (targetW / naturalW);
    if(targetH > maxH){
      targetH = maxH;
      targetW = naturalW * (targetH / naturalH);
      if(targetW > naturalW) targetW = naturalW;
    }
    // center target position in viewport
    const targetLeft = Math.round((vw - targetW) / 2);
    const targetTop = Math.round((vh - targetH) / 2);

    // animate (use left/top/width/height transitions for sharpness)
    requestAnimationFrame(()=>{
      backdrop.classList.add('show');
      clone.style.left = targetLeft + 'px';
      clone.style.top = targetTop + 'px';
      clone.style.width = Math.round(targetW) + 'px';
      clone.style.height = Math.round(targetH) + 'px';
    });

    function backdropClick(e){
      if(e.target === backdrop) closeImageZoom();
    }
    backdrop.addEventListener('click', backdropClick);
    clone.addEventListener('click', closeImageZoom);

    escKeyListener = (ev) => { if(ev.key === 'Escape') closeImageZoom(); };
    document.addEventListener('keydown', escKeyListener);

    currentZoom = { backdropEl: backdrop, cloneEl: clone, originalRect: rect, originalImgEl: imgEl };
  }

  function closeImageZoom(){
    if(!currentZoom) return;
    const { backdropEl, cloneEl, originalRect } = currentZoom;
    // animate back to original rect
    cloneEl.style.left = originalRect.left + 'px';
    cloneEl.style.top = originalRect.top + 'px';
    cloneEl.style.width = originalRect.width + 'px';
    cloneEl.style.height = originalRect.height + 'px';

    backdropEl.classList.remove('show');

    const cleanup = ()=>{
      if(backdropEl && backdropEl.parentNode) backdropEl.parentNode.removeChild(backdropEl);
      if(cloneEl && cloneEl.parentNode) cloneEl.parentNode.removeChild(cloneEl);
      document.body.classList.remove('img-zoom-open');
      document.body.style.overflow = '';
      if(escKeyListener) document.removeEventListener('keydown', escKeyListener);
      currentZoom = null;
    };

    const t = setTimeout(cleanup, 420);
    cloneEl.addEventListener('transitionend', function te(){
      clearTimeout(t);
      cloneEl.removeEventListener('transitionend', te);
      cleanup();
    });
  }

  // Helper: add zoom handler to an <img> element (only for A/B/C cards and non-leader units)
  function makeImgZoomable(imgEl){
    if(!imgEl) return;
    imgEl.style.cursor = 'zoom-in';
    imgEl.addEventListener('click', (e) => {
      e.stopPropagation();
      openImageZoomFromElement(imgEl);
    });
  }

  // ---------------------------
  // Rendering & logic
  // ---------------------------
  function renderLeaders(){
    leadersList.innerHTML = '';
    leaders.forEach(ld=>{
      const el = document.createElement('div');
      el.className = 'leader';
      el.dataset.id = ld.id;
      el.dataset.type = ld.type;
      el.tabIndex = 0;
      const src = (imageCache[ld.id] && imageCache[ld.id].src) ? imageCache[ld.id].src : ld.img;
      // leaders are NOT zoomable per request
      el.innerHTML = `<img src="${src}" alt="${ld.name}"><div class="label">${ld.name}</div>`;
      el.addEventListener('click', ()=> chooseLeader(ld.id));
      el.addEventListener('keydown', e => { if(e.key==='Enter' || e.key===' ') { e.preventDefault(); chooseLeader(ld.id);} });
      leadersList.appendChild(el);
    });
  }

  function makeCardCheckbox(card, checked=false, cls='', disabled=false, onToggle=null){
    const el = document.createElement('div');
    el.className = 'card-item';
    const cached = imageCache[card.id];
    const src = (cached && cached.src) ? cached.src : card.img;
    const cbId = `cb_${card.id}`;
    const disabledAttr = disabled ? 'disabled' : '';
    el.innerHTML = `
      <img src="${src}" alt="${card.name}">
      <div class="card-meta"><div class="small">${card.name}</div><div class="small">費:${card.cost} 上限:${card.maxCopies}</div></div>
      <div class="card-controls">
        <input data-card-id="${card.id}" data-card-type="${cls}" type="checkbox" id="${cbId}" ${checked?'checked':''} ${disabledAttr}>
        <label for="${cbId}" style="margin-left:6px;color:#cfe8ff">${disabled? '自動加入' : '加入大本營'}</label>
      </div>
    `;
    // Only A/B/C cards reach here (leaders handled separately), so it's OK to make zoomable
    makeImgZoomable(el.querySelector('img'));
    if(!disabled && onToggle){
      const checkbox = el.querySelector('input[type=checkbox]');
      checkbox.addEventListener('change', ()=> onToggle(card));
    }
    return el;
  }

  function renderACards(){
    aCardsArea.innerHTML = '';
    if(!chosenLeaderId){ aCardsArea.innerHTML = '<div class="hint">請先選擇領主以載入對應 A 卡</div>'; return; }
    const leader = leaders.find(l=>l.id===chosenLeaderId);
    (aCardsByType[leader.type]||[]).forEach(card=> aCardsArea.appendChild(makeCardCheckbox(card,true,'a-same',true,null)));
    Object.keys(aCardsByType).forEach(type=>{
      if(type === leader.type) return;
      aCardsByType[type].forEach(card=>{
        const node = makeCardCheckbox(card, campSelections.has(card.id), 'a-other', false, ()=> toggleOtherA(card));
        aCardsArea.appendChild(node);
      });
    });
  }
  function renderBCards(){ bCardsArea.innerHTML=''; bCards.forEach(card=> bCardsArea.appendChild(makeCardCheckbox(card, campSelections.has(card.id), 'b', false, ()=> toggleCampCard(card)))); }
  function renderCCards(){ cCardsArea.innerHTML=''; cCards.forEach(card=> cCardsArea.appendChild(makeCardCheckbox(card, campSelections.has(card.id), 'c', false, ()=> toggleCType(card)))); updateCCheckboxStates(); }

  function chooseLeader(id){
    chosenLeaderId = id;
    document.querySelectorAll('.leader').forEach(el => el.classList.toggle('selected', el.dataset.id === id));
    campSelections.clear();
    selectedOtherA.clear();
    selectedCtypes.clear();
    campSelections.add(id);
    const leader = leaders.find(l=>l.id===id);
    (aCardsByType[leader.type]||[]).forEach(card=>campSelections.add(card.id));
    renderACards(); renderBCards(); renderCCards(); updateLimitHints();
  }

  function toggleCampCard(card){ campSelections.has(card.id) ? campSelections.delete(card.id) : campSelections.add(card.id); }
  function toggleOtherA(card){
    const id = card.id;
    if(campSelections.has(id)){ campSelections.delete(id); selectedOtherA.delete(id); }
    else {
      if(selectedOtherA.size >= 2){ aLimitHint.classList.add('flash'); setTimeout(()=> aLimitHint.classList.remove('flash'),360); const cb=document.querySelector(`#cb_${id}`); if(cb) cb.checked=false; return; }
      campSelections.add(id); selectedOtherA.add(id);
    }
    updateLimitHints();
  }
  function toggleCType(card){
    const id = card.id; const checkbox = document.querySelector(`#cb_${id}`);
    if(campSelections.has(id)){ campSelections.delete(id); selectedCtypes.delete(id); updateCCheckboxStates(); updateLimitHints(); return; }
    if(selectedCtypes.size >= 2){ if(checkbox) checkbox.checked = false; cLimitHint.classList.add('flash'); setTimeout(()=> cLimitHint.classList.remove('flash'),360); return; }
    campSelections.add(id); selectedCtypes.add(id); updateCCheckboxStates(); updateLimitHints();
  }
  function updateCCheckboxStates(){ const checkboxes = Array.from(cCardsArea.querySelectorAll('input[type=checkbox]')); if(selectedCtypes.size >= 2){ checkboxes.forEach(cb=>{ if(cb.checked) return; cb.disabled = true; }); } else { checkboxes.forEach(cb=>cb.disabled = false); } }
  function updateLimitHints(){ aLimitHint.textContent = `已選擇其他 A 卡種類：${selectedOtherA.size} / 2（只能從未被自動加入的其他兩類 A 卡中選）`; cLimitHint.textContent = `已選擇 C 卡種類：${selectedCtypes.size} / 2`; }
  function resetCamp(){ chosenLeaderId=null; campSelections.clear(); selectedOtherA.clear(); selectedCtypes.clear(); renderACards(); renderBCards(); renderCCards(); document.querySelectorAll('.leader').forEach(el=>el.classList.remove('selected')); updateLimitHints(); }

  // build camp cards
  function buildCampCardsFromSelections(){
    const cards = [];
    if(chosenLeaderId){ const leader = leaders.find(l=>l.id===chosenLeaderId); cards.push({ id: leader.id, name: leader.name, img: leader.img, cost:0, maxCopies:1, isLeader:true }); }
    campSelections.forEach(id=>{
      if(id === chosenLeaderId) return;
      let found = null;
      Object.values(aCardsByType).some(arr=>{ const c = arr.find(x=>x.id===id); if(c){ found = c; return true;} return false; });
      if(!found) found = bCards.find(x=>x.id===id) || cCards.find(x=>x.id===id);
      if(found) cards.push({ id: found.id, name: found.name, img: found.img, cost: found.cost, maxCopies: found.maxCopies, isLeader:false });
    });
    campCards = cards;
    lineupCounts.clear();
    campCards.forEach(c => lineupCounts.set(c.id, c.isLeader ? 1 : 0));
    units.length = 0;
    if(chosenLeaderId){ const leader = leaders.find(l=>l.id===chosenLeaderId); const uid = 'leader_' + (Date.now()); units.push({ uid, cardId: leader.id, cardName: leader.name, upgrades: new Set(), upgradesCost: 0, isLeader: true }); }
    usedBudget = 0; updateBudgetDisplay(); updateSelectedCount();
  }

  // lineup UI & unit management code (same as before)...
  function renderLineupGallery(){
    lineupGallery.innerHTML = '';
    if(!campCards.length){ lineupGallery.innerHTML = '<div class="hint">請先建立大本營 (Camp) 以加入先發卡池。</div>'; return; }
    campCards.forEach(card=>{
      const wrap = document.createElement('div'); wrap.className = 'sub-card'; wrap.dataset.cardId = card.id;
      const cached = imageCache[card.id];
      const imgEl = document.createElement('img'); imgEl.src = (cached && cached.src) ? cached.src : card.img; imgEl.alt = card.name;
      // Only make zoomable when NOT leader
      if(!card.isLeader) makeImgZoomable(imgEl);

      const name = document.createElement('div'); name.className='card-name'; name.textContent = card.name;
      const cost = document.createElement('div'); cost.className='card-cost'; cost.textContent = `費用：${card.cost}`;
      const maxEl = document.createElement('div'); maxEl.className='card-max'; maxEl.textContent = `上限：${card.maxCopies} 張`;
      const controls = document.createElement('div'); controls.className='count-controls';
      if(card.isLeader){ const fixed = document.createElement('div'); fixed.className='count'; fixed.textContent='領主 (1)'; controls.appendChild(fixed); }
      else {
        const btnMinus = document.createElement('button'); btnMinus.textContent='−';
        const countSpan = document.createElement('div'); countSpan.className='count'; countSpan.textContent = lineupCounts.get(card.id) || 0;
        const btnPlus = document.createElement('button'); btnPlus.textContent='+';
        btnPlus.addEventListener('click', ()=> attemptAddCard(card, countSpan, btnPlus));
        btnMinus.addEventListener('click', ()=> attemptRemoveCard(card, countSpan));
        controls.appendChild(btnMinus); controls.appendChild(countSpan); controls.appendChild(btnPlus);
      }
      wrap.appendChild(imgEl); wrap.appendChild(name); wrap.appendChild(cost); wrap.appendChild(maxEl); wrap.appendChild(controls);
      lineupGallery.appendChild(wrap);
    });
    updatePlusButtonsState(); renderSelectedUnits();
  }

  function attemptAddCard(card, countSpan, plusButton){
    const current = lineupCounts.get(card.id) || 0;
    if(current >= card.maxCopies){ plusButton.classList.add('flash'); setTimeout(()=> plusButton.classList.remove('flash'),360); return; }
    if(usedBudget + card.cost > MAX_BUDGET){ remainingBudgetEl.classList.add('flash'); setTimeout(()=> remainingBudgetEl.classList.remove('flash'),360); plusButton.classList.add('flash'); setTimeout(()=> plusButton.classList.remove('flash'),360); return; }
    const uid = 'u_' + Date.now() + '_' + Math.floor(Math.random()*1000);
    units.push({ uid, cardId: card.id, cardName: card.name, upgrades: new Set(), upgradesCost: 0, isLeader:false });
    lineupCounts.set(card.id, current + 1);
    usedBudget += card.cost;
    countSpan.textContent = lineupCounts.get(card.id);
    updateBudgetDisplay(); updatePlusButtonsState(); renderSelectedUnits();
  }

  function attemptRemoveCard(card, countSpan){
    const current = lineupCounts.get(card.id) || 0;
    if(current <= 0) return;
    for(let i = units.length - 1; i >= 0; i--){
      if(units[i].cardId === card.id && !units[i].isLeader){
        const unit = units.splice(i,1)[0];
        usedBudget -= (card.cost + unit.upgradesCost);
        if(usedBudget < 0) usedBudget = 0;
        break;
      }
    }
    lineupCounts.set(card.id, current - 1);
    countSpan.textContent = lineupCounts.get(card.id);
    updateBudgetDisplay(); updatePlusButtonsState(); renderSelectedUnits();
  }

  function renderSelectedUnits(){
    selectedUnitsEl.innerHTML = '';
    if(units.length === 0){ selectedUnitsEl.innerHTML = '<div class="hint">你尚未選擇先發單位。按 + 新增，新增後可為單位加裝升級。</div>'; updateSelectedCount(); return; }
    const leaderUnit = units.find(u => u.isLeader);
    const otherUnits = units.filter(u => !u.isLeader);
    const ordered = leaderUnit ? [leaderUnit, ...otherUnits] : otherUnits;
    ordered.forEach(unit=>{
      const cardInfo = campCards.find(c=>c.id===unit.cardId) || { name: unit.cardName, img: '' };
      const el = document.createElement('div'); el.className = 'unit-card'; el.dataset.uid = unit.uid;
      const cached = imageCache[cardInfo.id];
      const src = (cached && cached.src) ? cached.src : cardInfo.img;
      el.innerHTML = `
        <img src="${src}" alt="${cardInfo.name}">
        <div style="display:flex;gap:8px;align-items:center;">
          <div style="flex:1;font-size:14px;font-weight:700">${cardInfo.name}</div>
        </div>
        <div class="unit-title">升級</div>
        <div class="upgrades"></div>
        <div class="unit-actions"></div>
      `;
      // Only non-leader unit images zoomable
      if(!unit.isLeader) makeImgZoomable(el.querySelector('img'));

      const upgradesContainer = el.querySelector('.upgrades');
      UPGRADES.forEach(up=>{
        const btn = document.createElement('button');
        btn.className = 'upgrade-btn' + (unit.upgrades.has(up.key) ? ' active' : '');
        btn.textContent = up.label;
        btn.dataset.uid = unit.uid;
        btn.dataset.upkey = up.key;
        btn.addEventListener('click', ()=> toggleUnitUpgrade(unit.uid, up.key));
        upgradesContainer.appendChild(btn);
      });
      const actionsContainer = el.querySelector('.unit-actions');
      if(!unit.isLeader){
        const removeBtn = document.createElement('button'); removeBtn.className = 'btn-small'; removeBtn.textContent = '移除單位';
        removeBtn.dataset.uid = unit.uid; removeBtn.addEventListener('click', (e)=> removeUnitByUid(e.currentTarget.dataset.uid));
        actionsContainer.appendChild(removeBtn);
      } else {
        const info = document.createElement('div'); info.style.opacity = '0.85'; info.style.fontSize = '13px';
        info.textContent = '領主（自動加入，可升級）'; actionsContainer.appendChild(info);
      }
      selectedUnitsEl.appendChild(el);
    });
    updateSelectedCount();
  }

  function toggleUnitUpgrade(uid, upkey){
    const unit = units.find(u=>u.uid===uid); if(!unit) return;
    const up = UPGRADES.find(x=>x.key===upkey); if(!up) return;
    if(unit.upgrades.has(upkey)){ unit.upgrades.delete(upkey); unit.upgradesCost -= up.cost; usedBudget -= up.cost; if(usedBudget < 0) usedBudget = 0; }
    else { if(usedBudget + up.cost > MAX_BUDGET){ remainingBudgetEl.classList.add('flash'); setTimeout(()=> remainingBudgetEl.classList.remove('flash'),360); return; } unit.upgrades.add(upkey); unit.upgradesCost += up.cost; usedBudget += up.cost; }
    updateBudgetDisplay(); renderSelectedUnits(); updatePlusButtonsState();
  }

  function removeUnitByUid(uid){
    const idx = units.findIndex(u=>u.uid===uid); if(idx === -1) return;
    const unit = units[idx]; if(unit.isLeader){ alert('領主為固定單位，無法移除。'); return; }
    units.splice(idx,1);
    const cardInfo = campCards.find(c=>c.id===unit.cardId);
    if(cardInfo){ usedBudget -= (cardInfo.cost + unit.upgradesCost); if(usedBudget < 0) usedBudget = 0; const cur = lineupCounts.get(unit.cardId) || 0; lineupCounts.set(unit.cardId, Math.max(0, cur - 1)); }
    else { usedBudget -= unit.upgradesCost; if(usedBudget < 0) usedBudget = 0; }
    updateBudgetDisplay(); renderLineupGallery();
  }

  function updatePlusButtonsState(){
    lineupGallery.querySelectorAll('.sub-card').forEach(cardEl=>{
      const id = cardEl.dataset.cardId; const info = campCards.find(c=>c.id===id);
      if(!info || info.isLeader) return;
      const plusBtn = cardEl.querySelector('.count-controls button:nth-child(3)');
      const current = lineupCounts.get(id) || 0;
      if((usedBudget + info.cost > MAX_BUDGET) || (current >= info.maxCopies)) plusBtn.disabled = true; else plusBtn.disabled = false;
    });
  }

  function updateBudgetDisplay(){ const remaining = Math.max(0, MAX_BUDGET - usedBudget); remainingBudgetEl.textContent = remaining; remainingBudgetEl.className = 'value'; if(remaining === 0) remainingBudgetEl.classList.add('over'); }
  function updateSelectedCount(){ selectedCountEl.textContent = units.length; }

  // ---------------------------
  // Export: draw images with containment and fixed image boxes (no cropping, no overlap)
  // ---------------------------
  async function exportDeckAsImage(deckName, tactics){
    const scaleFactor = 2;
    const baseW = 1200;
    const padding = 24;
    const cardsPerRow = 6;

    // fixed image box sizes (same for every small card)
    const cardImageW =  (Math.floor((baseW - padding*2 - (cardsPerRow-1)*12)/cardsPerRow)); // width of card box
    const cardImageH = 90; // height reserved for the image area (keeps uniform size)
    const labelH = 20; // label area under image
    const cardBoxH = cardImageH + labelH + 6; // total row height per card (consistent)

    const campRows = Math.ceil(campCards.length / cardsPerRow);
    const unitsPerRow = 4;
    const unitImageW = Math.floor((baseW - padding*2 - (unitsPerRow-1)*12)/unitsPerRow);
    const unitImageH = 110; // fixed unit image H
    const unitBoxH = unitImageH + labelH + 14; // total unit box height

    const unitRows = Math.max(1, Math.ceil(units.length / unitsPerRow));
    const headerH = 120;
    const hBase = padding*2 + headerH + campRows*cardBoxH + 24 + unitRows*(unitBoxH + 20);
    const canvasW = baseW * scaleFactor;
    const canvasH = Math.max(600, Math.floor(hBase * scaleFactor));

    const canvas = document.createElement('canvas');
    canvas.width = canvasW; canvas.height = canvasH;
    const ctx = canvas.getContext('2d');
    ctx.scale(scaleFactor, scaleFactor);

    // background & header
    ctx.fillStyle = '#071018'; ctx.fillRect(0,0,baseW,canvasH/scaleFactor);
    ctx.fillStyle = '#fff'; ctx.font = `700 28px sans-serif`; ctx.fillText(deckName, padding, padding + 28);
    ctx.font = `14px sans-serif`; ctx.fillStyle = '#cfe8ff';
    const tacticsLines = wrapText(ctx, tactics, baseW - padding*2);
    tacticsLines.forEach((ln,i)=> ctx.fillText(ln, padding, padding + 28 + (i+1)*18));
    const rem = Math.max(0, MAX_BUDGET - usedBudget);
    ctx.fillStyle = '#9ae6b4'; ctx.font = `600 14px sans-serif`;
    ctx.fillText(`剩餘費用: ${rem}`, baseW - padding - 220, padding + 24);
    ctx.fillText(`已選卡牌數量: ${units.length}`, baseW - padding - 220, padding + 44);

    // camp title
    let y = padding + headerH;
    ctx.fillStyle = '#cfe8ff'; ctx.font = `600 16px sans-serif`; ctx.fillText('大本營牌庫', padding, y - 10);

    // draw camp grid: each card uses fixed image box (cardImageW x cardImageH) and we CENTER and CONTAIN the original image into that box.
    let cx = padding; let cy = y + 12; let col = 0;
    campCards.forEach((c,i)=>{
      const img = imageCache[c.id] || null;
      // card background
      ctx.fillStyle = 'rgba(255,255,255,0.02)'; ctx.fillRect(cx, cy, cardImageW, cardBoxH - 6);
      // draw contained image centered inside (no cropping)
      if(img){
        // clip to the image box area to ensure no overflow (defensive)
        ctx.save();
        ctx.beginPath();
        ctx.rect(cx, cy, cardImageW, cardImageH);
        ctx.clip();
        drawImageContain(ctx, img, cx, cy, cardImageW, cardImageH);
        ctx.restore();
      } else {
        ctx.fillStyle = 'rgba(255,255,255,0.01)'; ctx.fillRect(cx, cy, cardImageW, cardImageH);
        ctx.fillStyle = '#ccc'; ctx.font = `12px sans-serif`; ctx.fillText('圖示無法載入', cx + 8, cy + (cardImageH/2));
      }
      // name under image in reserved label area
      ctx.fillStyle = '#fff'; ctx.font = `600 12px sans-serif`; ctx.fillText(c.name, cx + 6, cy + cardImageH + 14);
      col++; cx += cardImageW + 12; if(col >= cardsPerRow){ col = 0; cx = padding; cy += cardBoxH; }
    });

    // units section
    let unitsY = cy + 130;
    ctx.fillStyle = '#cfe8ff'; ctx.font = `600 16px sans-serif`; ctx.fillText('先發陣容與升級', padding, unitsY - 10);

    let ux = padding; let uy = unitsY + 12;
    units.forEach((u,i)=>{
      const card = campCards.find(c=>c.id===u.cardId) || { name:u.cardName, img: '' };
      const img = imageCache[card.id] || null;
      ctx.fillStyle = 'rgba(255,255,255,0.02)'; ctx.fillRect(ux, uy, unitImageW, unitBoxH - 10);
      if(img){
        ctx.save();
        ctx.beginPath();
        ctx.rect(ux, uy, unitImageW, unitImageH);
        ctx.clip();
        drawImageContain(ctx, img, ux, uy, unitImageW, unitImageH);
        ctx.restore();
      } else {
        ctx.fillStyle='rgba(255,255,255,0.01)'; ctx.fillRect(ux,uy,unitImageW,unitImageH);
        ctx.fillStyle='#ccc'; ctx.font='12px sans-serif'; ctx.fillText('圖示無法載入', ux + 8, uy + (unitImageH/2));
      }
      ctx.fillStyle = '#fff'; ctx.font = `600 13px sans-serif`; ctx.fillText(card.name, ux + 8, uy + unitImageH + 16);
      ctx.fillStyle = '#9ae6b4'; ctx.font = `500 12px sans-serif`;
      const ups = Array.from(u.upgrades).map(k=> (UPGRADES.find(x=>x.key===k) || {}).label ).filter(Boolean);
      const upText = ups.length ? ups.join(' / ') : '無';
      wrapDrawText(ctx, upText, ux + 8, uy + unitImageH + 36, unitImageW - 12, 14);
      ux += unitImageW + 12;
      if((i+1) % unitsPerRow === 0){ ux = padding; uy += unitBoxH + 20; }
    });

    return new Promise((resolve)=>{
      canvas.toBlob(function(blob){
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        const safe = deckName.replace(/[^\w\-_\u4e00-\u9fff]/g,'_') || 'deck';
        a.download = `${safe}.png`;
        document.body.appendChild(a);
        a.click();
        setTimeout(()=> { URL.revokeObjectURL(a.href); document.body.removeChild(a); resolve(); }, 1500);
      }, 'image/png');
    });
  }

  // drawImageContain: draw image fully inside box, preserve original aspect ratio; image is centered, not cropped
  function drawImageContain(ctx, img, x, y, w, h){
    if(!img) return;
    const iw = img.width || 1, ih = img.height || 1;
    const scale = Math.min(w/iw, h/ih);
    const nw = iw * scale;
    const nh = ih * scale;
    const dx = x + (w - nw) / 2;
    const dy = y + (h - nh) / 2;
    try { ctx.drawImage(img, dx, dy, nw, nh); } catch(e){ ctx.fillStyle='rgba(255,255,255,0.02)'; ctx.fillRect(x,y,w,h); }
  }

  // helpers
  function wrapText(ctx, text, maxWidth){
    if(!text) return [];
    const words = text.split(/\s+/);
    const lines = []; let line = '';
    for(let i=0;i<words.length;i++){
      const test = line ? (line + ' ' + words[i]) : words[i];
      const w = ctx.measureText(test).width;
      if(w > maxWidth && line){ lines.push(line); line = words[i]; } else { line = test; }
    }
    if(line) lines.push(line);
    return lines;
  }
  function wrapDrawText(ctx, text, x, y, maxW, lineH){
    const words = text.split(' '); let line = ''; let curY = y;
    for(let i=0;i<words.length;i++){
      const test = line ? (line + ' ' + words[i]) : words[i];
      const w = ctx.measureText(test).width;
      if(w > maxW && line){ ctx.fillText(line, x, curY); line = words[i]; curY += lineH; } else { line = test; }
    }
    if(line) ctx.fillText(line, x, curY);
  }

  // ---------------------------
  // Notification modal for card count rule
  // ---------------------------
  function showCountNotification(message){
    const backdrop = document.createElement('div'); backdrop.className = 'modal-backdrop';
    const modal = document.createElement('div'); modal.className = 'modal';
    modal.innerHTML = `
      <h3>卡牌數量不符規定</h3>
      <div style="color:#cfe8ff;margin-top:8px">${message}</div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;">
        <button id="okCountNotify" class="btn-primary">好</button>
      </div>
    `;
    backdrop.appendChild(modal);
    document.body.appendChild(backdrop);
    modal.querySelector('#okCountNotify').addEventListener('click', ()=> {
      document.body.removeChild(backdrop);
    });
  }

  // Init and event wiring (same as previous)
  async function init(){
    document.getElementById('enterLineupBtn').disabled = true;
    document.getElementById('confirmBtn').disabled = true;
    document.getElementById('clearLineupBtn').disabled = true;
    document.getElementById('resetCampBtn').disabled = true;

    await preloadImagesForAll();

    document.getElementById('enterLineupBtn').disabled = false;
    document.getElementById('confirmBtn').disabled = false;
    document.getElementById('clearLineupBtn').disabled = false;
    document.getElementById('resetCampBtn').disabled = false;

    renderLeaders(); renderACards(); renderBCards(); renderCCards(); updateLimitHints();
  }

  document.getElementById('tabCamp').addEventListener('click', ()=> { tabCamp.classList.add('active'); tabLineup.classList.remove('active'); campStage.style.display = ''; lineupStage.style.display = 'none'; });
  document.getElementById('tabLineup').addEventListener('click', ()=> { tabLineup.classList.add('active'); tabCamp.classList.remove('active'); campStage.style.display = 'none'; lineupStage.style.display = ''; });

  // ENTER LINEUP: build camp -> lineup (no final-count check here)
  document.getElementById('enterLineupBtn').addEventListener('click', ()=> {
    if(!chosenLeaderId){ alert('請先選擇一位領主。'); return; }
    buildCampCardsFromSelections();
    renderLineupGallery();
    tabLineup.click();
  });

  document.getElementById('resetCampBtn').addEventListener('click', ()=> { if(!confirm('重置大本營會清除已選擇內容，確定嗎？')) return; resetCamp(); });
  document.getElementById('backToCampBtn').addEventListener('click', ()=> { tabCamp.click(); });
  document.getElementById('clearLineupBtn').addEventListener('click', ()=> { if(!confirm('重置先發將清除所有選擇數量與升級，確定嗎？')) return; const leaderUnit = units.find(u => u.isLeader); units.length = 0; if(leaderUnit) units.push(leaderUnit); lineupCounts.clear(); campCards.forEach(c => lineupCounts.set(c.id, c.isLeader ? 1 : 0)); usedBudget = 0; updateBudgetDisplay(); renderLineupGallery(); });

  // CONFIRM: check selected units count (including leader) is 7~10 before opening confirm modal
  document.getElementById('confirmBtn').addEventListener('click', ()=> {
    const totalSelectedUnits = units.length; // includes leader if present
    if(totalSelectedUnits < 7 || totalSelectedUnits > 10){
      showCountNotification(`先發單位數量必須為 7 ~ 10 張（包含領主）。目前已選擇 ${totalSelectedUnits} 張。請調整後再確認。`);
      return;
    }
    openConfirmModal();
  });

  function openConfirmModal(){
    const backdrop = document.createElement('div'); backdrop.className = 'modal-backdrop';
    const modal = document.createElement('div'); modal.className = 'modal';
    modal.innerHTML = `
      <h3>匯出先發陣容</h3>
      <label>副牌組名稱：</label>
      <input id="deckName" type="text" placeholder="輸入牌組名稱">
      <label>戰術打法：</label>
      <textarea id="deckTactics" rows="4" placeholder="輸入戰術說明"></textarea>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;">
        <button id="cancelExport" class="btn-ghost">取消</button>
        <button id="doExport" class="btn-primary">匯出為高畫質圖片</button>
      </div>
      <div style="font-size:12px;margin-top:8px;color:#cfe8ff">備註：使用 repo 的相對路徑 images/，在 GitHub Pages 中 CORS 不會阻擋。</div>
    `;
    backdrop.appendChild(modal); document.body.appendChild(backdrop);
    modal.querySelector('#cancelExport').addEventListener('click', ()=> document.body.removeChild(backdrop));
    modal.querySelector('#doExport').addEventListener('click', async ()=> { const name = modal.querySelector('#deckName').value || '未命名牌組'; const tactics = modal.querySelector('#deckTactics').value || ''; await exportDeckAsImage(name, tactics); document.body.removeChild(backdrop); });
  }

  init();
</script>
</body>
</html>
